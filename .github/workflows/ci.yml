name: CI

on:
  push:
  pull_request:

jobs:
  dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install jinja2 pyyaml; fi
      - name: Dry run (non-mutating)
        run: |
          python -m payload_generator.cli \
            --findings samples/findings.canonical.json \
            --this-is-a-demo \
            --dry-run
      - name: Ensure out/ NOT created
        run: |
          test ! -d out || (echo "out/ exists after --dry-run; should be non-mutating" && exit 1)
      - name: Safety: only allow-listed origins
        run: |
          awk '/^- /{print $2}' config/allowlist.yaml | sed 's/"//g;s/'"'"'//g' > /tmp/allowed.txt || true
          ALL=$(git ls-files 'payload_generator/templates/*' 'out/snippets/*' 2>/dev/null || true)
          BAD=0
          for f in $ALL; do
            URLS=$(grep -Eho 'https?://[^"'"'"' )>]+' "$f" 2>/dev/null | sort -u || true)
            for u in $URLS; do
              ORIGIN=$(echo "$u" | awk -F/ '{print $1"//"$3}')
              if ! grep -Fxq "$ORIGIN" /tmp/allowed.txt; then
                echo "::error file=$f::Non-allowlisted URL origin: $ORIGIN"
                BAD=1
              fi
            done
          done
          exit $BAD

  build-artifacts:
    runs-on: ubuntu-latest
    needs: dry-run
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install jinja2 pyyaml; fi
      - name: Generate artifacts
        run: |
          python -m payload_generator.cli \
            --findings samples/findings.canonical.json \
            --this-is-a-demo \
            --out-dir out
      - name: Hash outputs
        run: |
          find out -type f -print0 | sort -z | xargs -0 sha256sum > out.sha256
          cat out.sha256
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generator-out
          path: |
            out/**
            out.sha256
            out/plan.json
            out/catalog.csv
