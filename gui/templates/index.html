<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSP Analyzer</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }

        h1 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .section {
            margin-top: 30px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 4px;
        }

        .finding {
            background-color: #f9f9f9;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 15px;
        }

        .finding.high {
            border-left-color: #dc3545;
        }

        .payload {
            background-color: #f0f0f0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        pre {
            background-color: #333;
            color: #fff;
            padding: 10px;
            overflow-x: auto;
            border-radius: 4px;
        }

        .hidden {
            display: none;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .badge.high {
            background-color: #dc3545;
        }

        .badge.med {
            background-color: #ffc107;
            color: #333;
        }
    </style>
</head>

<body>
    <h1>CSP Analyzer</h1>

    <div class="input-group">
        <input type="text" id="urlInput" placeholder="Enter URL (e.g. https://google.com)" value="https://google.com">
        <button id="scanBtn" onclick="runScan()">Analyze</button>
    </div>

    <div id="loading" class="hidden">Analyzing...</div>

    <div id="results" class="hidden">
        <div class="section">
            <h2>Findings</h2>
            <div id="findingsList"></div>
        </div>

        <div class="section">
            <h2>Payloads</h2>
            <div id="payloadsList"></div>
        </div>
    </div>

    <script>
        async function runScan() {
            const url = document.getElementById('urlInput').value;
            const btn = document.getElementById('scanBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');

            btn.disabled = true;
            loading.classList.remove('hidden');
            results.classList.add('hidden');

            document.getElementById('findingsList').innerHTML = '';
            document.getElementById('payloadsList').innerHTML = '';

            try {
                // 1. Analyze
                const analyzeRes = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const analysis = await analyzeRes.json();

                if (analysis.error) throw new Error(analysis.error);

                // Render Findings
                const findingsDiv = document.getElementById('findingsList');
                if (analysis.findings.length === 0) {
                    findingsDiv.innerHTML = '<p>No vulnerabilities found.</p>';
                } else {
                    analysis.findings.forEach(f => {
                        const el = document.createElement('div');
                        el.className = `finding ${f.severity}`;
                        el.innerHTML = `
                            <h3><span class="badge ${f.severity}">${f.severity.toUpperCase()}</span> ${f.type}</h3>
                            <p>${f.details.message || 'Potential CSP bypass.'}</p>
                            <pre>${JSON.stringify(f.details, null, 2)}</pre>
                        `;
                        findingsDiv.appendChild(el);
                    });
                }

                // 2. Generate Payloads
                if (analysis.findings.length > 0) {
                    const genRes = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ findings: analysis.findings })
                    });
                    const generation = await genRes.json();

                    if (generation.error) throw new Error(generation.error);

                    const payloadsDiv = document.getElementById('payloadsList');
                    window.lastSnippets = generation.snippets;
                    window.lastAnalysis = analysis;

                    generation.snippets.forEach((s, index) => {
                        const el = document.createElement('div');
                        el.className = 'payload';
                        el.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h4>${s.name}</h4>
                                <button onclick="verifyPayload('${index}', this)">Verify</button>
                            </div>
                            <div id="verify-result-${index}"></div>
                            <pre>${s.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                        `;
                        payloadsDiv.appendChild(el);
                    });
                } else {
                    document.getElementById('payloadsList').innerHTML = '<p>No payloads generated.</p>';
                }

                results.classList.remove('hidden');

            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        }

        async function verifyPayload(index, btn) {
            const snippet = window.lastSnippets[index];
            const resultDiv = document.getElementById(`verify-result-${index}`);

            btn.disabled = true;
            btn.textContent = 'Verifying...';
            resultDiv.innerHTML = '';

            try {
                let csp = null;
                if (window.lastAnalysis && window.lastAnalysis.findings.length > 0) {
                    const f = window.lastAnalysis.findings[0];
                    if (f.details && f.details.raw) {
                        csp = f.details.raw;
                    }
                }

                const res = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        payload: snippet.content,
                        csp: csp
                    })
                });
                const result = await res.json();

                if (result.success) {
                    resultDiv.innerHTML = '<p style="color:green; font-weight:bold;">✅ Verified Bypass</p>';
                } else {
                    resultDiv.innerHTML = `<p style="color:red;">❌ Blocked: ${result.error || 'Unknown error'}</p>`;
                }

            } catch (e) {
                resultDiv.innerHTML = `<p style="color:red;">Error: ${e.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Verify';
            }
        }
    </script>
</body>

</html>